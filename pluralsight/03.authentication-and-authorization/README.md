# Authentication and Authorization in PHP

## What is authentication?

Overview:

- A rapid introduction to authentication
- Learn about two common types:
  - HTTP authentication
  - Form-based authentication

The process of verifying the identity of a user, process or device, often as a
prerequisite to allowing access to resources in an information system.

There are multiple authentication types:

- Single-factor authentication
- Multi-factor authentication

### Single-factor Authentication

- Form: filling out username and password
- Biometric data: fingerprint
- An additional item: smart card

### The difference between Authentication and Authorization

- In authentication: you're determining if a user is valid
- In authorization: a user has already been validated

The benefits:

- Only valid users have access
- Access is appropriately authorized

### About HTTP Authentication

Authentication framework, which can be used by a server to challenge a
client request, and by a client to provide authentication information, as
defined by RFC 7235

- Doesn't use login pages
- Uses HTTP headers
- There are 6 types
  - Basic
  - Digest
  - Bearer
  - ...

### About Form-based Authentication

- Has no formal specification
- Uses HTTP and HTML elements (input, hidden, password field)
- It very flexible
- Can be very creative

Please be aware for session cookies:

- Set the HttpOnly and Secure flags to avoid XSS attacks

## HTTP Authentication

Overview:

- What is HTTP authentication?
- Common HTTP authentication methods
- Relevant HTTP headers
- Advantages and disadvantages
- Why HTTPS is essential
- How to implement it in PHP

### What is?

> An authentication framework, which can be used by a server to challenge a client
> request, and by a client to provide authentication information, as defined by
> RFC 7235. It doesn't use login pages, cookies, or session identifiers, rather
> (it uses) standard fields in the HTTP header

### How does HTTP Authentication work?

![Authentication Overview](http_authentication_overview.png)

### HTTP `Basic` Authentication

- Simplistic authentication process
- Authentication method string is `Basic`
- Credentials are colon-concatenated and base64-encoded

![HTTP basic authentication overview](http_basic_authentication_overview.png)

Advantages

- Simple to implement
- Quick to deliver
- Passwords can be encrypted
- One round-trip required
- Part of the HTTP specification

Disadvantages

- Credentials are not encrypted
- Vulnerable to Man-in-the-middle attacks
  - Essentials to use HTTPS/TLS
- How do you logout?
  - Restart your browser
  - Clear browser's cache
  - Authenticate with incorrect credentials
- Not the most professional user experience

### Implemnet in PHP

- `PHP_AUTH_USER`: authenticated user
- `PHP_AUTH_PW`: password
- `AUTH_TYPE`: type of authentication

```php
$username = 'admin';
$password = 'admin';

if (!isset($_SERVER['PHP_AUTH_USER'])) {
  header('WWW-Authenticate: Basic realm="Parcel Tracker"');
  header('HTTP/1.0 401 Unauthorized');
  echo 'You must provide a valid username and password to access this application';
  exit;
}

if (
  $_SERVER['PHP_AUTH_USER'] !== $username ||
  $_SERVER['PHP_AUTH_PW'] !== $password
) {
  header('HTTP/1.0 401 Unauthorized');
  echo 'Either your username or password was not valid\n';
  exit;
}
```

### HTTP `Digest` Authentication

Overview:

- Defined in RFC 2069
- Added security enhancements in RFC 2617
- More complex than Basic authentication
- Credentials are hashed
- Uses additional security features
- Replacement for Basic Authentication
- Client credentials are not sent in plain text
- Uses a server-generated nonce

> A nonce is an arbitrary number that can be used just once in a cryptographic
> communication

- Body sent in plain text

Security properties

- Domain: An optionall, quoted, space-separated list of URIs which are
  protected by this authentication request

- Opaque: A base64-encoded or hexadecimal string generated by the server and used in communication with the server

- Stale: A flag that indicates that the previous request from the client was
  rejected because the nonce value was stale

- Algorithm: This indicates the algorithm used to produce the digest. It is
  assumed to be MD5 if it is not specified

- Nonce: A unique code generated by the server every time a 401 response is
  sent. It is either a base64-encoded or hexadecimal value. This helps the
  server guard against replay attacks

> A replay attack is a form of network attack
> in which a valid data transmission is
> maliciously or fraudulently repeated or
> delayed. This is carried out either by the
> originator or by an adversary who intercepts
> the data and re-transmits it, possibly as part
> of a masquerade attack by IP packet substituion

- qop: Quality of Protection. It can be set to one of `auth` or `auth-int`.
  This influences how the hash is created and is an integrity code for the request.
  If it is set to `auth`, only the requested URI will be taken into consideration. If it is `auth-int` the body of the request will aloso be used in the hash

- cnonce: A unique id generated by the client. This value helps both the client and server prove that they have a known shared secret. It's required when the server sends a "qop". It must not be sent if the server did not send a qop directive

- nonce-count: Nonce count. This is a hexadecimall count of the number of requests that the client has sent with the nonce value used in the request. It allows the server to detect request replays

![HTTP digest authentication](http_digest_authentication.png)

Advantages:

- Part of the HTTP specification
- Password is never sent in the clear
- Includes a server nonce
- Incldes a client nonce

Disadvantages

- Some header fields are optional
- Security level cannot be guarateed
- Vulnerable to Man-in-the-middle attacks
- Prevents stronger password hashing

## Form-based Authentication

Overview:

- Form-based authentication
- What it is
- How it works
- How to implement it in PHP
- Advantages and disadvantages
- Security considerations

### What is form-based authentication?

> There is no formalized specification

```php
<form method="POST" action="/login">
  username: <input type="text" name="username" required>
  password: <input type="password" name="password" required>
  <input name="__csrf" type="hidden" value="tronghieuthiha">
  <button type="submit">Login</button>
</form>
```

> Cross-Site Request Forgery (CSRF) is an attack that forces an end user to execute
> unwanted actions on a web application in which they're currently authenticated.
> With a little help of social engineering an attacker may trick the users of a
> web application into executing actions of the attacker's choosing

Details:

- `Web App Hacking: Cross-Site Request Forgery (CSRF)` in Pluralsight
- `Web Security and the OWASP Top 10: The Big Picture`

Flow

![HTTP Form-based Authentication](http_form_authentication.png)

> HTTP Is a Stateless Protocol

Given this, one request is not natively connected in any way to any other.
So, how to maintan state between requests?

Sessions

- Perform authentication over HTTPS
- Session id identifies a user's session data
- `$_SESSION` is populated with unserialised session data
- Data in `$_SESSION` is serialized on PHP shutdown or call to session_write_close
- Session data is saved in flat files by default
- Determined by `session.save_handler`
- File location is set in `session.save_path`
- Session data can be stored in other ways
